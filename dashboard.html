<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SariSariGo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: #30c685;
        }
        .hover-lift {
            transition: all 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .chart-container {
            background: #51e76f ;
        }
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 16px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 font-inter">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4 md:space-x-8">
                    <a href="index.html" class="flex items-center">
                        <img src="products/logo.png" alt="SariSariGo" class="h-8 w-auto mr-3 object-contain" onerror="this.style.display='none'">
                        <span class="text-2xl font-bold text-green-600">SariSariGo</span>
                    </a>
                    <nav id="desktop-nav" class="hidden md:flex items-center space-x-8">
                        <a href="index.html" class="text-gray-600 hover:text-green-600 transition">Home</a>
                        <a href="products.html" class="text-gray-600 hover:text-green-600 transition">Products</a>
                        <a href="vendors.html" class="text-gray-600 hover:text-green-600 transition">Vendors</a>
                    </nav>
                </div>
                <div class="flex-1 max-w-lg mx-4">
                    <div class="relative">
                        <input id="search-input" type="search" placeholder="Search for products..." autocomplete="off"
                               class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500">
                        <button id="search-btn" class="absolute inset-y-0 right-0 flex items-center pr-3" type="button">
                            <i class="fas fa-search text-gray-400"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="relative text-gray-600 hover:text-green-600 transition">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-4" id="auth-links">
                        <!-- Auth links will be populated by JavaScript -->
                    </div>
                    <button id="mobile-menu-btn" class="md:hidden text-gray-600 hover:text-green-600 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
            <nav class="flex flex-col space-y-2 px-4 py-4">
                <a href="index.html" class="text-gray-600 hover:text-green-600 hover:bg-green-50 px-4 py-2 rounded transition">Home</a>
                <a href="products.html" class="text-gray-600 hover:text-green-600 hover:bg-green-50 px-4 py-2 rounded transition">Products</a>
                <a href="vendors.html" class="text-gray-600 hover:text-green-600 hover:bg-green-50 px-4 py-2 rounded transition">Vendors</a>
                <a href="dashboard.html" class="text-gray-600 hover:text-green-600 hover:bg-green-50 px-4 py-2 rounded transition">Dashboard</a>
                <hr class="my-2">
                <a href="login.html" class="text-gray-600 hover:text-green-600 hover:bg-green-50 px-4 py-2 rounded transition">Login</a>
                <a href="register.html" class="text-green-500 hover:bg-green-50 px-4 py-2 rounded transition font-semibold">Register</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Welcome Banner -->
        <div class="gradient-bg rounded-2xl p-8 text-white mb-8 shadow-xl relative overflow-hidden">
            <div class="absolute inset-0 bg-black opacity-10"></div>
            <div class="relative z-10">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="flex-1">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">Welcome back, <span id="welcome-name" class="text-yellow-300">User</span>! ðŸ‘‹</h1>
                        <p class="text-blue-100 text-lg">Here's what's happening with your store today</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-4">
                        <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center backdrop-blur-sm">
                            <p class="text-sm opacity-90">Account Type</p>
                            <p class="font-semibold text-lg" id="welcome-role">Buyer</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center backdrop-blur-sm">
                            <p class="text-sm opacity-90">Joined</p>
                            <p class="font-semibold text-lg" id="member-since">2024</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <!-- Buyer stats (default visible for buyers) -->
        <div id="buyer-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 shadow-lg hover-lift border border-white">
                <div class="flex items-center">
                    <div class="bg-green-100 p-4 rounded-2xl mr-4">
                        <i class="fas fa-shopping-cart text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Total Orders</p>
                        <p class="text-3xl font-bold text-gray-800" id="total-orders">0</p>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm text-green-600">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span>Updated recently</span>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg hover-lift border border-white">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-4 rounded-2xl mr-4">
                        <i class="fas fa-hourglass-end text-yellow-600 text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">To Pay</p>
                        <p class="text-3xl font-bold text-gray-800" id="to-pay-count">0</p>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm text-yellow-600">
                    <i class="fas fa-clock mr-1"></i>
                    <span>Pending payment</span>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg hover-lift border border-white">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-4 rounded-2xl mr-4">
                        <i class="fas fa-box text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">To Receive</p>
                        <p class="text-3xl font-bold text-gray-800" id="to-receive-count">0</p>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm text-blue-600">
                    <i class="fas fa-truck mr-1"></i>
                    <span>In transit</span>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg hover-lift border border-white">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-4 rounded-2xl mr-4">
                        <i class="fas fa-star text-purple-600 text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">To Review</p>
                        <p class="text-3xl font-bold text-gray-800" id="to-review-count">0</p>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm text-purple-600">
                    <i class="fas fa-comment mr-1"></i>
                    <span>Pending review</span>
                </div>
            </div>
        </div>

        <!-- Order Tracking Section -->
        <div id="order-tracking-panel" class="glass-card rounded-2xl p-6 shadow-lg border border-white mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-2xl mr-4">
                        <i class="fas fa-shipping-fast text-white text-xl"></i>
                    </div>
                    Order Tracking
                </h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="track-order-input" placeholder="Enter Order ID..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button id="track-order-btn" class="bg-indigo-500 text-white px-6 py-2 rounded-xl hover:bg-indigo-600 transition">
                        Track Order
                    </button>
                </div>
            </div>

            <!-- Active Orders -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Active Orders</h3>
                <div id="active-orders-list" class="space-y-4">
                    <!-- Active orders will be loaded here -->
                </div>
            </div>

            <!-- Order Tracking Details -->
            <div id="tracking-details" class="hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="tracking-order-title">Order #</h3>
                            <p class="text-gray-600" id="tracking-order-date"></p>
                        </div>
                        <div class="text-right">
                            <span id="tracking-order-status" class="status-badge bg-yellow-100 text-yellow-800">Pending</span>
                            <p class="text-sm text-gray-600 mt-1" id="tracking-order-total"></p>
                        </div>
                    </div>
                </div>

                <!-- Tracking Timeline -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Order Progress</h4>
                    <div id="tracking-timeline" class="relative">
                        <!-- Timeline will be generated here -->
                    </div>
                </div>

                <!-- Order Items -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Order Items</h4>
                    <div id="tracking-order-items" class="bg-gray-50 rounded-xl p-4">
                        <!-- Order items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- No Orders Message -->
            <div id="no-active-orders" class="hidden text-center py-8">
                <div class="text-6xl text-gray-300 mb-4">
                    <i class="fas fa-box-open"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No Active Orders</h3>
                <p class="text-gray-500">You don't have any active orders at the moment.</p>
                <a href="products.html" class="inline-block mt-4 bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 transition">
                    Start Shopping
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Profile Section -->
            <div class="lg:col-span-2">
                <div class="glass-card rounded-2xl p-6 shadow-lg border border-white">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 p-3 rounded-2xl mr-4">
                                <i class="fas fa-user-circle text-white text-xl"></i>
                            </div>
                            Profile Information
                        </h2>
                        <button id="edit-profile-btn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all flex items-center">
                            <i class="fas fa-edit mr-2"></i> Edit Profile
                        </button>
                    </div>
                    
                    <div id="profile-display" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <p class="text-xl font-semibold text-gray-900" id="profile-name">Loading...</p>
                            </div>
                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <p class="text-xl font-semibold text-gray-900" id="profile-email">Loading...</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Account Role</label>
                                <p class="text-xl font-semibold text-gray-900" id="profile-role">Loading...</p>
                            </div>
                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Member Since</label>
                                <p class="text-xl font-semibold text-gray-900" id="profile-join-date">2024</p>
                            </div>
                        </div>
                    </div>

                    <div id="profile-edit" class="hidden space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" id="edit-name" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="edit-email" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button id="save-profile-btn" class="bg-green-500 text-white px-8 py-3 rounded-xl hover:bg-green-600 transition flex items-center shadow-lg">
                                <i class="fas fa-save mr-2"></i> Save Changes
                            </button>
                            <button id="cancel-edit-btn" class="bg-gray-500 text-white px-8 py-3 rounded-xl hover:bg-gray-600 transition flex items-center">
                                <i class="fas fa-times mr-2"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="space-y-6">
                <div class="glass-card rounded-2xl p-6 shadow-lg border border-white">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-rocket text-green-500 mr-3"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-3 mt-4">
                        <a href="products.html" class="flex items-center p-3 rounded-xl bg-blue-50 text-blue-700 hover:bg-blue-100 transition">
                            <i class="fas fa-shopping-cart mr-3"></i>
                            Browse Products
                        </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-2xl p-6 shadow-lg border border-white">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-history text-orange-500 mr-3"></i>
                        Recent Activity
                    </h3>
                    <div class="space-y-4 mt-4" id="recent-activity">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Buyer Panel (Only for buyers) -->
        <div id="buyer-panel" class="hidden">
            <div class="glass-card rounded-2xl p-6 shadow-lg border border-white">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-3 rounded-2xl mr-4">
                            <i class="fas fa-shopping-bag text-white text-xl"></i>
                        </div>
                        Your Order History
                    </h2>
                    <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium" id="buyer-orders-count">0 orders</span>
                </div>
                
                <div id="buyer-orders-container">
                    <!-- Orders will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl p-8 w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Add New Product</h3>
                    <button id="cancel-add-product" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="add-product-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" name="name" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price (â‚±)</label>
                            <input type="number" name="price" step="0.01" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" required rows="3" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
                            <input type="number" name="stock" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select name="category" required class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                                <option value="">Select Category</option>
                                <!-- Categories will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                        <input type="text" name="imageUrl" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition" placeholder="products/image.jpg">
                    </div>
                    
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold py-4 px-6 rounded-xl hover:shadow-lg transition-all flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>


    <script src="app.js"></script>
    <script>
        // Mobile menu toggle (defensive)
        (function() {
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (btn && menu) {
                btn.addEventListener('click', function() {
                    menu.classList.toggle('hidden');
                });
                menu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        menu.classList.add('hidden');
                    });
                });
            }
        })();

        // Enhanced Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Reload current user from localStorage to get fresh data
            const rawUser = localStorage.getItem('currentUser');
            const currentUser = rawUser ? JSON.parse(rawUser) : AppState.currentUser;
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Only redirect vendors to vendor-orders page
            if (currentUser.role === 'vendor') {
                window.location.href = 'vendor-orders.html';
                return;
            }
            
            // If buyer role, continue to initialize dashboard
            if (currentUser.role === 'buyer') {
                initializeDashboard();
                return;
            }

            // Fallback - unknown role, show error
            Utils.showNotification('Unknown account type', 'error');
            window.location.href = 'login.html';
        });

        function initializeDashboard() {
            loadProfileData();
            loadQuickStats();
            loadRecentActivity();
            setupEventListeners();
            updateHeaderForRole();
            initializeOrderTracking();
        
        }

        function loadProfileData() {
            const currentUser = AppState.currentUser;
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-role').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                document.getElementById('edit-name').value = currentUser.name;
                document.getElementById('edit-email').value = currentUser.email;
                
                // Update welcome section
                document.getElementById('welcome-name').textContent = currentUser.name;
                document.getElementById('welcome-role').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                document.getElementById('member-since').textContent = new Date().getFullYear();
                document.getElementById('profile-join-date').textContent = new Date().getFullYear();
            }
        }

        function loadQuickStats() {
            const currentUser = AppState.currentUser;
            if (!currentUser) return;
            // Buyer stats
            const userOrders = DB.orders.filter(order => order.userId === currentUser.id);

            // Calculate order counts by status
            const toPayCount = userOrders.filter(order => order.status === 'pending').length;
            const toReceiveCount = userOrders.filter(order => 
                ['confirmed', 'preparing', 'shipped', 'out_for_delivery', 'ready_for_pickup'].includes(order.status)
            ).length;
            const toReviewCount = userOrders.filter(order => order.status === 'delivered').length;
            
            // Update stats display
            document.getElementById('total-orders').textContent = userOrders.length;
            document.getElementById('to-pay-count').textContent = toPayCount;
            document.getElementById('to-receive-count').textContent = toReceiveCount;
            document.getElementById('to-review-count').textContent = toReviewCount;
        }

        function loadRecentActivity() {
            const activityContainer = document.getElementById('recent-activity');
            if (!activityContainer) return;

            const currentUser = AppState.currentUser;
            const userOrders = DB.orders
                .filter(order => order.userId === currentUser.id)
                .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
                .slice(0, 5);

            if (userOrders.length === 0) {
                activityContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No recent activity</p>';
                return;
            }

            activityContainer.innerHTML = userOrders.map(order => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                            <i class="fas fa-bag-shopping text-blue-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">Order #${order.id}</p>
                            <p class="text-sm text-gray-500">${new Date(order.orderDate).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <span class="font-semibold text-gray-700">${Utils.formatPrice(order.total)}</span>
                </div>
            `).join('');
        }

        function loadBuyerOrders() {
            const currentUser = AppState.currentUser;
            const ordersContainer = document.getElementById('buyer-orders-container');
            const buyerOrders = DB.orders.filter(order => order.userId === currentUser.id);
            
            // Update orders count
            document.getElementById('buyer-orders-count').textContent = `${buyerOrders.length} orders`;
            
            if (buyerOrders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-bag text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No orders yet</h3>
                        <p class="text-gray-500 mb-6">Start shopping to see your orders here!</p>
                        <a href="products.html" class="bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 transition inline-flex items-center">
                            <i class="fas fa-shopping-cart mr-2"></i> Start Shopping
                        </a>
                    </div>
                `;
            } else {
                ordersContainer.innerHTML = buyerOrders.map(order => {
                    const vendor = DB.users.find(u => u.id === order.vendorId);
                    const itemsCount = order.items ? order.items.length : 0;
                    
                    return `
                        <div class="border border-gray-200 rounded-xl p-5 mb-4 hover:shadow-md transition">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-3">
                                        <div class="bg-gray-100 p-2 rounded-lg mr-3">
                                            <i class="fas fa-store text-gray-600"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-lg text-gray-800">${vendor ? vendor.name : 'Unknown Vendor'}</h3>
                                            <p class="text-sm text-gray-500">Order #${order.id} â€¢ ${new Date(order.orderDate).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                        <div>
                                            <p class="text-sm text-gray-600">Items</p>
                                            <p class="font-medium">${itemsCount} item${itemsCount !== 1 ? 's' : ''}</p>
                                            <button onclick="showOrderDetails(${order.id})" class="text-blue-600 hover:text-blue-800 text-sm mt-1">
                                                View all items
                                            </button>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Payment</p>
                                            <span class="payment-badge ${order.paymentMethod === 'gcash' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                ${order.paymentMethod === 'gcash' ? 'Paid Online' : 'Cash on Delivery'}
                                                ${order.paymentMethod === 'gcash' && order.gcashReference ? `<br><small>Ref: ${order.gcashReference}</small>` : ''}
                                            </span>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Total</p>
                                            <p class="font-semibold text-lg text-green-600">${Utils.formatPrice(order.total || 0)}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 md:mt-0 md:ml-4 flex flex-col items-end">
                                    <span class="status-badge ${getStatusColor(order.status)} mb-2">${order.status}</span>
                                    <div class="flex flex-col items-end space-y-2">
                                        <button onclick="showOrderDetails(${order.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                            Order Details
                                        </button>
                                        ${currentUser && currentUser.role === 'buyer' && order.userId === currentUser.id && ['pending','confirmed'].includes(order.status) ? `
                                        <button onclick="cancelOrder(${order.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                            Cancel Order
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function showOrderDetails(orderId) {
            const order = DB.orders.find(o => o.id === orderId);
            if (!order) {
                Utils.showNotification('Order not found', 'error');
                return;
            }

            const customer = DB.users.find(u => u.id === order.userId);
            const vendor = DB.users.find(u => u.id === order.vendorId);
            const paymentStatus = order.paymentMethod === 'gcash' ? 'Paid Online' : 'Cash on Delivery';
            
            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                itemsHtml = order.items.map(item => {
                    const product = DB.products.find(p => p.id === item.productId);
                    return `
                        <div class="order-item flex justify-between items-center py-3 px-4 border-b border-gray-100">
                            <div class="flex items-center">
                                <img src="${product ? product.imageUrl : 'https://via.placeholder.com/100x100?text=No+Image'}" 
                                     alt="${product ? product.name : 'Unknown Product'}" 
                                     class="h-12 w-12 rounded object-cover mr-3"
                                     onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
                                <div>
                                    <p class="font-medium text-gray-900">${product ? product.name : 'Unknown Product'}</p>
                                    <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-medium text-gray-900">${Utils.formatPrice(item.price)}</p>
                                <p class="text-sm text-gray-500">Subtotal: ${Utils.formatPrice(item.price * item.quantity)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Order Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm font-medium text-gray-700 mb-1">Order Information</p>
                                <p class="font-semibold">Order #${order.id}</p>
                                <p class="text-sm text-gray-600">Placed on ${new Date(order.orderDate).toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm font-medium text-gray-700 mb-1">Delivery Method</p>
                                <p class="font-semibold">${order.deliveryMethod === 'delivery' ? 'Home Delivery' : 'Store Pickup'}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm font-medium text-gray-700 mb-1">Customer Information</p>
                                <p class="font-semibold">${customer ? customer.name : 'Unknown Customer'}</p>
                                <p class="text-sm text-gray-600">${order.customerPhone || 'No phone provided'}</p>
                                <p class="text-sm text-gray-600">${order.customerAddress || 'No address provided'}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm font-medium text-gray-700 mb-1">Vendor Information</p>
                                <p class="font-semibold">${vendor ? vendor.name : 'Unknown Vendor'}</p>
                                <p class="text-sm text-gray-600">${vendor ? vendor.storeAddress || 'No address provided' : ''}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl">
                            <p class="text-sm font-medium text-gray-700 mb-2">Payment Information</p>
                            <div class="flex items-center">
                                <span class="payment-badge ${order.paymentMethod === 'gcash' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} mr-2">
                                    ${paymentStatus}
                                </span>
                                ${order.paymentMethod === 'gcash' && order.gcashReference ? 
                                    `<span class="text-sm text-gray-600">Reference: ${order.gcashReference}</span>` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">Order Items (${order.items ? order.items.length : 0})</p>
                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                ${itemsHtml || '<p class="p-4 text-center text-gray-500">No items found</p>'}
                                <div class="bg-gray-50 p-4 flex justify-between items-center">
                                    <span class="font-semibold text-gray-800">Total Amount:</span>
                                    <span class="font-bold text-lg text-green-600">${Utils.formatPrice(order.total || 0)}</span>
                                </div>
                            </div>
                            ${AppState.currentUser && AppState.currentUser.role === 'buyer' && order.userId === AppState.currentUser.id && ['pending','confirmed'].includes(order.status) ? `
                            <div class="mt-4 flex justify-end">
                                <button onclick="cancelOrder(${order.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Cancel Order</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Order Tracking Functionality
        function initializeOrderTracking() {
            loadActiveOrders();
            setupOrderTracking();
        }

        function setupOrderTracking() {
            const trackOrderBtn = document.getElementById('track-order-btn');
            const trackOrderInput = document.getElementById('track-order-input');
            
            if (trackOrderBtn && trackOrderInput) {
                trackOrderBtn.addEventListener('click', () => {
                    const orderId = parseInt(trackOrderInput.value.trim());
                    if (orderId) {
                        trackOrder(orderId);
                    } else {
                        Utils.showNotification('Please enter a valid Order ID', 'error');
                    }
                });
                
                trackOrderInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        trackOrderBtn.click();
                    }
                });
            }
        }

        function loadActiveOrders() {
            const activeOrdersList = document.getElementById('active-orders-list');
            const noActiveOrders = document.getElementById('no-active-orders');
            
            if (!activeOrdersList) return;
            
            const currentUser = AppState.currentUser;
            if (!currentUser) return;
            
            let userOrders = [];
            
            if (currentUser.role === 'buyer') {
                userOrders = DB.orders.filter(order => 
                    order.userId === currentUser.id && 
                    order.status !== 'delivered' && 
                    order.status !== 'completed' && 
                    order.status !== 'cancelled'
                );
            } else if (currentUser.role === 'vendor') {
                userOrders = DB.orders.filter(order => 
                    order.vendorId === currentUser.id && 
                    order.status !== 'delivered' && 
                    order.status !== 'completed' && 
                    order.status !== 'cancelled'
                );
            }
            
            // Render using shared renderer
            renderOrdersCards(userOrders, activeOrdersList, noActiveOrders);
        }

        // Shared renderer for lists of orders into a container element
        function renderOrdersCards(orders, containerEl, emptyEl) {
            if (!containerEl) return;
            if (!orders || orders.length === 0) {
                containerEl.classList.add('hidden');
                if (emptyEl) emptyEl.classList.remove('hidden');
                return;
            }

            containerEl.classList.remove('hidden');
            if (emptyEl) emptyEl.classList.add('hidden');

            const currentUser = AppState.currentUser;

            containerEl.innerHTML = orders.map(order => {
                const vendor = Utils.getVendorById(order.vendorId);
                const customer = DB.users.find(u => u.id === order.userId);
                const itemsCount = order.items ? order.items.length : 0;

                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="bg-blue-100 p-3 rounded-xl">
                                    <i class="fas fa-shopping-bag text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">Order #${order.id}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${currentUser.role === 'buyer' ? 
                                          `Vendor: ${vendor ? vendor.name : 'Unknown'}` : 
                                          `Customer: ${customer ? customer.name : 'Unknown'}`}
                                    </p>
                                    <p class="text-xs text-gray-500">${itemsCount} item${itemsCount !== 1 ? 's' : ''} â€¢ ${new Date(order.orderDate).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="status-badge ${getStatusColor(order.status)}">${order.status}</span>
                                <p class="text-sm font-semibold text-gray-800 mt-1">${Utils.formatPrice(order.total)}</p>
                                <button onclick="trackOrder(${order.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium mt-2">
                                    Track Order
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        function trackOrder(orderId) {
            const order = DB.orders.find(o => o.id === orderId);
            if (!order) {
                Utils.showNotification('Order not found', 'error');
                return;
            }
            
            const trackingDetails = document.getElementById('tracking-details');
            const vendor = Utils.getVendorById(order.vendorId);
            const customer = DB.users.find(u => u.id === order.userId);
            
            if (trackingDetails) {
                trackingDetails.classList.remove('hidden');
                
                // Update order information
                document.getElementById('tracking-order-title').textContent = `Order #${order.id}`;
                document.getElementById('tracking-order-date').textContent = `Placed on ${new Date(order.orderDate).toLocaleString()}`;
                document.getElementById('tracking-order-status').textContent = order.status;
                document.getElementById('tracking-order-status').className = `status-badge ${getStatusColor(order.status)}`;
                document.getElementById('tracking-order-total').textContent = `Total: ${Utils.formatPrice(order.total)}`;
                
                // Update tracking timeline
                renderTrackingTimeline(order);
                
                // Update order items
                renderTrackingOrderItems(order);
                
                // Scroll to tracking details
                trackingDetails.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderTrackingTimeline(order) {
            const timelineContainer = document.getElementById('tracking-timeline');
            if (!timelineContainer) return;
            
            const steps = getOrderTrackingSteps(order);
            
            timelineContainer.innerHTML = `
                <div class="space-y-6">
                    ${steps.map((step, index) => `
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center">
                                <div class="w-8 h-8 rounded-full ${step.completed ? 'bg-green-500' : step.active ? 'bg-blue-500' : 'bg-gray-300'} flex items-center justify-center text-white font-bold">
                                    ${step.completed ? 'âœ“' : index + 1}
                                </div>
                                ${index < steps.length - 1 ? '<div class="w-1 h-12 bg-gray-300 mt-2"></div>' : ''}
                            </div>
                            <div class="flex-1 pb-6 ${index < steps.length - 1 ? 'border-b border-gray-200' : ''}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 ${step.completed ? 'text-green-600' : step.active ? 'text-blue-600' : 'text-gray-500'}">
                                            ${step.title}
                                        </h4>
                                        <p class="text-sm text-gray-600 mt-1">${step.description}</p>
                                        ${step.date ? `<p class="text-xs text-gray-500 mt-1">${step.date}</p>` : ''}
                                    </div>
                                    ${step.completed ? 
                                        '<span class="text-green-500 text-sm font-medium">Completed</span>' : 
                                        step.active ? 
                                        '<span class="text-blue-500 text-sm font-medium">In Progress</span>' : 
                                        '<span class="text-gray-400 text-sm">Pending</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getOrderTrackingSteps(order) {
            const baseSteps = [
                { 
                    title: 'Order Placed', 
                    description: 'Your order has been successfully placed.',
                    completed: true,
                    active: false,
                    date: new Date(order.orderDate).toLocaleDateString()
                },
                { 
                    title: 'Order Confirmed', 
                    description: 'Vendor has confirmed your order.',
                    completed: ['confirmed', 'preparing', 'shipped', 'out_for_delivery', 'delivered', 'completed'].includes(order.status),
                    active: order.status === 'confirmed',
                    date: order.status === 'confirmed' ? 'Today' : null
                },
                { 
                    title: order.deliveryMethod === 'delivery' ? 'Preparing for Delivery' : 'Preparing for Pickup', 
                    description: order.deliveryMethod === 'delivery' ? 'Your items are being prepared for delivery.' : 'Your items are being prepared for pickup.',
                    completed: ['preparing', 'shipped', 'out_for_delivery', 'delivered', 'completed'].includes(order.status),
                    active: order.status === 'preparing',
                    date: ['preparing', 'shipped', 'out_for_delivery', 'delivered', 'completed'].includes(order.status) ? 'Today' : null
                }
            ];
            
            if (order.deliveryMethod === 'delivery') {
                baseSteps.push(
                    { 
                        title: 'Shipped', 
                        description: 'Your order has been shipped and is on its way.',
                        completed: ['shipped', 'out_for_delivery', 'delivered', 'completed'].includes(order.status),
                        active: order.status === 'shipped',
                        date: ['shipped', 'out_for_delivery', 'delivered', 'completed'].includes(order.status) ? 'Today' : null
                    },
                    { 
                        title: 'Out for Delivery', 
                        description: 'Your order is out for delivery.',
                        completed: ['out_for_delivery', 'delivered', 'completed'].includes(order.status),
                        active: order.status === 'out_for_delivery',
                        date: ['out_for_delivery', 'delivered', 'completed'].includes(order.status) ? 'Today' : null
                    },
                    { 
                        title: 'Delivered', 
                        description: 'Your order has been delivered.',
                        completed: ['delivered', 'completed'].includes(order.status),
                        active: order.status === 'delivered',
                        date: ['delivered', 'completed'].includes(order.status) ? 'Today' : null
                    }
                );
            } else {
                baseSteps.push(
                    { 
                        title: 'Ready for Pickup', 
                        description: 'Your order is ready for pickup at the store.',
                        completed: ['ready_for_pickup', 'completed'].includes(order.status),
                        active: order.status === 'ready_for_pickup',
                        date: ['ready_for_pickup', 'completed'].includes(order.status) ? 'Today' : null
                    },
                    { 
                        title: 'Picked Up', 
                        description: 'Your order has been picked up.',
                        completed: order.status === 'completed',
                        active: false,
                        date: order.status === 'completed' ? 'Today' : null
                    }
                );
            }
            
            return baseSteps;
        }

        function renderTrackingOrderItems(order) {
            const itemsContainer = document.getElementById('tracking-order-items');
            if (!itemsContainer || !order.items) return;
            
            itemsContainer.innerHTML = order.items.map(item => {
                const product = DB.products.find(p => p.id === item.productId);
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-0">
                        <div class="flex items-center space-x-3">
                            <img src="${product ? product.imageUrl : 'https://via.placeholder.com/60x60?text=Product'}" 
                                 alt="${product ? product.name : 'Product'}" 
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://via.placeholder.com/60x60?text=Product'">
                            <div>
                                <h5 class="font-medium text-gray-800">${product ? product.name : 'Unknown Product'}</h5>
                                <p class="text-sm text-gray-600">Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">${Utils.formatPrice(item.price)}</p>
                            <p class="text-sm text-gray-600">Subtotal: ${Utils.formatPrice(item.price * item.quantity)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Rating System Functions
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            return 'â˜…'.repeat(fullStars) + (hasHalfStar ? 'Â½' : '') + 'â˜†'.repeat(emptyStars);
        }

        function calculateProductAverageRating(productId) {
            const product = DB.products.find(p => p.id === productId);
            if (!product || !product.ratings || product.ratings.length === 0) {
                return 0;
            }
            
            const sum = product.ratings.reduce((total, rating) => total + rating.rating, 0);
            return sum / product.ratings.length;
        }

        function getProductRatingCount(productId) {
            const product = DB.products.find(p => p.id === productId);
            return product && product.ratings ? product.ratings.length : 0;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'Processing': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'preparing': 'bg-indigo-100 text-indigo-800',
                'shipped': 'bg-purple-100 text-purple-800',
                'out_for_delivery': 'bg-orange-100 text-orange-800',
                'ready_for_pickup': 'bg-green-100 text-green-800',
                'delivered': 'bg-green-100 text-green-800',
                'completed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function setupEventListeners() {
            // Profile editing
            document.getElementById('edit-profile-btn').addEventListener('click', () => {
                document.getElementById('profile-display').classList.add('hidden');
                document.getElementById('profile-edit').classList.remove('hidden');
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('profile-display').classList.remove('hidden');
                document.getElementById('profile-edit').classList.add('hidden');
            });

            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);

            // Product management (vendor only) - handled by setupVendorTabs
            if (AppState.currentUser.role === 'vendor') {
                document.getElementById('add-product-form').addEventListener('submit', addNewProduct);
            }

            // Developer tools
            const clearDbBtn = document.getElementById('clear-db-btn');
            if (clearDbBtn) clearDbBtn.addEventListener('click', clearLocalDB);
            const viewDbBtn = document.getElementById('view-db-btn');
            if (viewDbBtn) viewDbBtn.addEventListener('click', viewDB);
            const refreshDataBtn = document.getElementById('refresh-data-btn');
            if (refreshDataBtn) refreshDataBtn.addEventListener('click', refreshData);
            const exportDataBtn = document.getElementById('export-data-btn');
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);

            // Stat card click handlers - filter & scroll to Order Tracking
            const totalOrdersElem = document.getElementById('total-orders');
            const toPayElem = document.getElementById('to-pay-count');
            const toReceiveElem = document.getElementById('to-receive-count');
            const toReviewElem = document.getElementById('to-review-count');

            if (totalOrdersElem) totalOrdersElem.addEventListener('click', () => filterAndShowOrders('all'));
            if (toPayElem) toPayElem.addEventListener('click', () => filterAndShowOrders('toPay'));
            if (toReceiveElem) toReceiveElem.addEventListener('click', () => filterAndShowOrders('toReceive'));
            if (toReviewElem) toReviewElem.addEventListener('click', () => filterAndShowOrders('toReview'));

            // Vendor analytics button
            const viewAnalyticsBtn = document.getElementById('view-analytics-btn');
            if (viewAnalyticsBtn) viewAnalyticsBtn.addEventListener('click', () => showVendorAnalytics());
        }

        // Filter orders by category and show in the Order Tracking panel
        function filterAndShowOrders(category) {
            const currentUser = AppState.currentUser;
            if (!currentUser) return;

            let orders = DB.orders.filter(o => o.userId === currentUser.id);

            if (category === 'toPay') {
                orders = orders.filter(o => o.status === 'pending');
            } else if (category === 'toReceive') {
                orders = orders.filter(o => ['confirmed', 'preparing', 'shipped', 'out_for_delivery', 'ready_for_pickup'].includes(o.status));
            } else if (category === 'toReview') {
                orders = orders.filter(o => o.status === 'delivered');
            } // 'all' leaves orders unfiltered

            const activeOrdersList = document.getElementById('active-orders-list');
            const noActiveOrders = document.getElementById('no-active-orders');
            const trackingPanel = document.getElementById('order-tracking-panel');

            // Ensure the tracking panel is visible
            if (trackingPanel) trackingPanel.classList.remove('hidden');

            // Render filtered orders into the active orders list area
            renderOrdersCards(orders, activeOrdersList, noActiveOrders);

            // Scroll to the tracking panel for visibility
            if (trackingPanel) trackingPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function saveProfile() {
            const name = document.getElementById('edit-name').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const currentUser = AppState.currentUser;

            if (!name || !email) {
                Utils.showNotification('Please fill in all fields', 'error');
                return;
            }

            const updatedUser = Utils.updateUser(currentUser.id, { name, email });
            if (updatedUser) {
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                AppState.currentUser = updatedUser;
                loadProfileData();
                document.getElementById('profile-display').classList.remove('hidden');
                document.getElementById('profile-edit').classList.add('hidden');
                Utils.updateAuthLinks();
                Utils.showNotification('Profile updated successfully!', 'success');
            }
        }

        function addNewProduct(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const currentUser = AppState.currentUser;

            const productData = {
                vendorId: currentUser.id,
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category'),
                stock: parseInt(formData.get('stock')),
                imageUrl: formData.get('imageUrl') || 'products/default.jpg'
            };

            Utils.addProduct(productData);
            document.getElementById('add-product-modal').classList.add('hidden');
            e.target.reset();
            loadVendorProducts();
            loadQuickStats();
            loadRecentActivity();
        }

        function editProduct(productId) {
            const product = DB.products.find(p => p.id === productId);
            if (product) {
                const newName = prompt('Enter new product name:', product.name);
                const newPrice = prompt('Enter new price:', product.price);
                const newStock = prompt('Enter new stock:', product.stock);

                if (newName !== null && newPrice !== null && newStock !== null) {
                    const updates = {};
                    if (newName) updates.name = newName;
                    if (newPrice) updates.price = parseFloat(newPrice);
                    if (newStock) updates.stock = parseInt(newStock);
                    
                    Utils.updateProduct(productId, updates);
                    loadVendorProducts();
                    loadQuickStats();
                }
            }
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                Utils.deleteProduct(productId);
                loadVendorProducts();
                loadQuickStats();
            }
        }

        function updateOrderStatus(orderId) {
            const order = DB.orders.find(o => o.id === orderId);
            if (order) {
                const newStatus = prompt('Enter new status (pending/confirmed/preparing/shipped/out_for_delivery/delivered/ready_for_pickup/completed/cancelled):', order.status);
                if (newStatus) {
                    Utils.updateOrderStatus(orderId, newStatus);
                    if (AppState.currentUser.role === 'vendor') {
                        loadVendorOrders();
                    } else {
                        loadBuyerOrders();
                    }
                    loadQuickStats();
                    loadActiveOrders();
                }
            }
        }

        // Buyer cancellation helper
        function cancelOrder(orderId) {
            const order = DB.orders.find(o => o.id === orderId);
            if (!order) {
                Utils.showNotification('Order not found', 'error');
                return;
            }
            // Only allow buyer who owns the order to cancel
            const currentUser = AppState.currentUser;
            if (!currentUser || currentUser.role !== 'buyer' || order.userId !== currentUser.id) {
                Utils.showNotification('You are not authorized to cancel this order', 'error');
                return;
            }

            // Only allow cancellation for certain statuses
            const cancelable = ['pending', 'confirmed'];
            if (!cancelable.includes(order.status)) {
                Utils.showNotification('This order cannot be cancelled at its current status', 'error');
                return;
            }

            const reason = prompt('Please enter cancellation reason (optional):');
            if (reason === null) return; // user aborted

            const success = App.cancelOrder(orderId, reason || '');
            if (success) {
                // Close any open modal(s)
                document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
                loadBuyerOrders();
                loadActiveOrders();
                loadQuickStats();
            }
        }

        function refreshData() {
            if (AppState.currentUser.role === 'vendor') {
                loadVendorProducts();
                loadVendorOrders();
            } else {
                loadBuyerOrders();
            }
            loadQuickStats();
            loadRecentActivity();
            loadActiveOrders();
            Utils.showNotification('Data refreshed successfully!', 'success');
        }

        function exportData() {
            const dataStr = JSON.stringify(DB, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sarisarigo-data-backup.json';
            link.click();
            URL.revokeObjectURL(url);
            Utils.showNotification('Data exported successfully!', 'success');
        }

        function clearLocalDB() {
            if (confirm('Are you sure you want to clear all local data? This cannot be undone.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function viewDB() {
            console.log('Current DB:', DB);
            console.log('AppState:', AppState);
            alert('Database has been logged to console. Check Developer Tools (F12).');
        }

        // Hide main nav for vendors, show only dashboard
        function updateHeaderForRole() {
            const mainNav = document.getElementById('main-nav');
            if (mainNav && AppState.currentUser && AppState.currentUser.role === 'vendor') {
                mainNav.classList.add('hidden');
            } else if (mainNav) {
                mainNav.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>